<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8"/>
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
      <style>
         .links line {
           stroke: #999;
           stroke-width: 1;
           stroke-opacity: 0.6;
           marker-end: url(#arrowhead);
         }

         .nodes circle {
           stroke-width: 1.5px;
         }

			svg {
				border: 1px solid black;
				display: block;
			}    

			div.analysis {
				display: inline-block;
			}    

         div.dashboard {
            display: none;
            position: relative;
            top: -35px;
            background: rgba(0,0,0,0.4);
            height: 35px;
            color: white;
            font-size: 18px;
            text-align: left;
         }

         div.analysis:hover div.dashboard {
            display: block;
         }

         .button {
            padding: 8px; 
         }

         .button:hover {
            background: black;
         }
      </style>
   </head>
   <body>
		<center>
			<div class="analysis">
				<svg width="1024" height="768">
					<defs>
                  <marker id="arrowhead" viewBox="0 -5 10 10" refX="21" refY="0" markerWidth="5" markerHeight="5" orient="auto">
                  <path d="M0,-5L10,0L0,5"></path>
                  </marker>
					</defs>
				</svg>
				<div class="dashboard">
               <i id="buttonPlayPause" class="button fas fa-pause" onclick="clickPlayPause(this)"></i><i id="buttonReset" class="button fas fa-sync-alt" onclick="initSimulation()"></i>
				</div>
			</div>
		</center>
      <script src="https://d3js.org/d3.v4.min.js"></script>
      <script>
         var nodes = {{ nodes }};

         var links = {{ links }};

         var active = 1;

         var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

         var simulation = null,
             link = null,
             node = null;

         var initSimulation = function() {
            if (simulation) {
               simulation.stop();
            }
            svg.selectAll('g').remove();
            nodes.forEach(function (n) { n.x=null; n.y=null; });

            var color = d3.scaleOrdinal(d3.schemeCategory20);

            simulation = d3.forceSimulation()
               .force("link", d3.forceLink().id(function(d) { return d.id; }))
               .force("charge", d3.forceManyBody())
               .force("center", d3.forceCenter(width / 2, height / 2));

            link = svg.append("g")
               .attr("class", "links")
               .selectAll("line")
               .data(links)
                  .enter().append("line")

            node = svg.append("g")
               .attr("class", "nodes")
               .selectAll("circle")
               .data(nodes)
               .enter().append("circle")
                  .attr("r", 5)
                  .attr("stroke", function(d) { return color(d.ownerclass); })
                  .attr("fill", function(d) { if (d.type === "method") { return color(d.ownerclass); } else { return "#fff"; } })
                  .call(d3.drag()
                     .on("start", dragstarted)
                     .on("drag", dragged)
                     .on("end", dragended));

            node.append("title")
               .text(function(d) { return d.id; });

            simulation
               .nodes(nodes)
               .on("tick", ticked);

            simulation.force("link")
               .links(links);
         }

         initSimulation();

         function ticked() {
            link
               .attr("x1", function(d) { return d.source.x; })
               .attr("y1", function(d) { return d.source.y; })
               .attr("x2", function(d) { return d.target.x; })
               .attr("y2", function(d) { return d.target.y; });

            node
               .attr("cx", function(d) { return d.x = Math.max(6, Math.min(width - 6, d.x)); })
               .attr("cy", function(d) { return d.y = Math.max(6, Math.min(height - 6, d.y)); });
         }

         function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
         }

         function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
         }

         function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
         }

         function clickPlayPause(b) {
            if (active) {
               active = 0;
               simulation.stop();
               b.className = "button fas fa-play";
            } else {
               active = 1;
               simulation.restart();
               b.className = "button fas fa-pause";
            }
         }

         document.onkeydown = function (e) {
            e = e || window.event;
            switch (e.which || e.keyCode) {
               case 13:
                  document.getElementById("buttonPlayPause").click();
                  break;
            }
         }
      </script>
   </body>
</html>
